<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>WebSocket STOMP Chat Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: auto;
        }

        .input-group {
            margin-bottom: 10px;
            display: flex;
        }

        .input-group input {
            flex-grow: 1;
            padding: 8px;
        }

        .input-group button {
            padding: 8px 12px;
        }

        #chat-area {
            display: none;
            margin-top: 20px;
        }

        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
            list-style-type: none;
        }

        #messages li {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>

<body>

    <div class="container">
        <h2>STOMP Chat Test Client</h2>

        <div id="connect-area" class="input-group">
            <input type="text" id="roomId" placeholder="채팅방 번호(ID)를 입력하세요">
            <button id="connectButton">채팅방 입장</button>
        </div>

        <div id="chat-area">
            <h3 id="roomTitle"></h3>
            <ul id="messages"></ul>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
                <button id="sendButton">전송</button>
            </div>
        </div>
    </div>

    <script>
        // DOM 요소 가져오기
        const connectArea = document.getElementById('connect-area');
        const chatArea = document.getElementById('chat-area');
        const roomTitle = document.getElementById('roomTitle');
        const connectButton = document.getElementById('connectButton');
        const sendButton = document.getElementById('sendButton');
        const roomIdInput = document.getElementById('roomId');
        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');

        const sender = "User_" + Math.floor(Math.random() * (1000 - 0 + 1)) + 0

        let stompClient = null;
        let currentSubscription = null;
        let currentRoomId = null;

        // '채팅방 입장' 버튼 클릭 이벤트
        connectButton.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId) {
                connectAndSubscribe(roomId);
            } else {
                alert('채팅방 번호를 입력해주세요.');
            }
        });

        // '전송' 버튼 클릭 이벤트
        sendButton.addEventListener('click', sendMessage);

        function connectAndSubscribe(roomId) {
            // 이미 연결된 상태라면 이전 구독을 해지하고 연결을 종료
            if (stompClient) {
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                }
                stompClient.deactivate();
            }

            currentRoomId = roomId;

            // 1. STOMP 클라이언트 생성
            // Postman 테스트용으로 만든 순수 WebSocket 엔드포인트(/ws-native)를 사용합니다.
            // 만약 /ws-stomp를 사용하려면 SockJS 라이브러리도 추가로 필요합니다.
            stompClient = new StompJs.Client({
                // brokerURL 대신 webSocketFactory를 사용
                webSocketFactory: () => {
                    // SockJS를 통해 연결. 주소는 http로 시작합니다.
                    return new SockJS("http://localhost:8080/ws-stomp");
                },
                debug: function (str) {
                    console.log(str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            // 2. 연결 성공 시 콜백 함수
            stompClient.onConnect = (frame) => {
                console.log('STOMP 연결 성공:', frame);

                // UI 변경
                connectArea.style.display = 'none';
                chatArea.style.display = 'block';
                roomTitle.textContent = `채팅방 #${currentRoomId}`;

                // 3. 채팅방 구독
                const subscriptionDestination = `/sub/${currentRoomId}`;
                currentSubscription = stompClient.subscribe(subscriptionDestination, (message) => {
                    // 메시지 수신 시 처리
                    displayMessage(JSON.parse(message.body));
                });
                console.log(`구독 시작: ${subscriptionDestination}`);
            };

            // 4. STOMP 오류 발생 시 콜백
            stompClient.onStompError = (frame) => {
                console.error('브로커 오류:', frame);
            };

            // 5. 연결 시작
            stompClient.activate();
        }

        // 메시지 전송 함수
        function sendMessage() {
            const messageContent = messageInput.value.trim();
            if (messageContent && stompClient && stompClient.connected) {
                const destination = `/pub/${currentRoomId}`;
                const chatMessage = {
                    type: 'TALK', // 메시지 타입 추가
                    sender: sender,
                    content: messageContent,
                };

                stompClient.publish({
                    destination: destination,
                    body: JSON.stringify(chatMessage),
                });
                messageInput.value = '';
            } else {
                alert('메시지를 입력하거나 연결 상태를 확인하세요.');
            }
        }

        // 수신된 메시지를 화면에 표시하는 함수
        function displayMessage(message) {
            const li = document.createElement('li');

            // 메시지 타입에 따라 스타일을 다르게 적용
            if (message.type === 'ENTER' || message.type === 'LEAVE') {
                li.textContent = `[알림] ${message.content}`;
                li.style.color = 'gray';
                li.style.textAlign = 'center';
            } else { // 'TALK' 타입
                li.textContent = `${message.sender}: ${message.content}`;
            }

            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        }

    </script>

</body>

</html>